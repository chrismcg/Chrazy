// handle_mo4l_sysex.js

inlets = 1;
outlets = 2;

var param_to_nprn_map = {
  0:   0,
  1:   1,
  2:   2,
  3:   3,
  4:   4,
  5:   114,
  6:   5,
  7:   6,
  8:   7,
  9:   8,
  10:  9,
  11:  115,
  12:  10,
  13:  11,
  14:  12,
  15:  93,
  16:  96,
  17:  13,
  18:  14,
  19:  116,
  20:  15,
  21:  16,
  22:  17,
  23:  18,
  24:  19,
  25:  20,
  26:  21,
  27:  22,
  28:  23,
  29:  24,
  30:  25,
  31:  26,
  32:  27,
  33:  30,
  34:  31,
  35:  32,
  36:  33,
  37:  34,
  38:  35,
  39:  36,
  40:  29,
  41:  37,
  42:  38,
  43:  39,
  44:  40,
  45:  41,
  46:  42,
  47:  43,
  48:  44,
  49:  45,
  50:  46,
  51:  47,
  52:  48,
  53:  49,
  54:  50,
  55:  51,
  56:  52,
  57:  53,
  58:  54,
  59:  55,
  60:  56,
  61:  57,
  62:  58,
  63:  59,
  64:  60,
  65:  61,
  66:  62,
  67:  63,
  68:  64,
  69:  98,
  70:  65,
  71:  66,
  72:  67,
  73:  68,
  74:  69,
  75:  70,
  76:  71,
  77:  72,
  78:  73,
  79:  74,
  80:  75,
  81:  76,
  82:  81,
  83:  82,
  84:  83,
  85:  84,
  86:  85,
  87:  86,
  88:  87,
  89:  88,
  90:  89,
  91:  90,
  92:  111,
  93:  112,
  94:  113,
  95:  91,
  96:  92,
  97:  97,
  98:  100,
  99:  94,
  100: 101,
  101: 77,
  102: 78,
  103: 79,
  104: 80,
  105: 105,
  106: 106,
  107: 107,
  108: 108,
  109: 109,
  110: 110,
  111: 111,
  112: 112,
  113: 113,
  114: 114,
  115: 115,
  116: 116,
  117: 117,
  118: 118,
  119: 119,
  120: 'sequencer',
  121: 'sequencer',
  122: 'sequencer',
  123: 'sequencer',
  124: 'sequencer',
  125: 'sequencer',
  126: 'sequencer',
  127: 'sequencer',
  128: 'sequencer',
  129: 'sequencer',
  130: 'sequencer',
  131: 'sequencer',
  132: 'sequencer',
  133: 'sequencer',
  134: 'sequencer',
  135: 'sequencer',
  136: 'sequencer',
  137: 'sequencer',
  138: 'sequencer',
  139: 'sequencer',
  140: 'sequencer',
  141: 'sequencer',
  142: 'sequencer',
  143: 'sequencer',
  144: 'sequencer',
  145: 'sequencer',
  146: 'sequencer',
  147: 'sequencer',
  148: 'sequencer',
  149: 'sequencer',
  150: 'sequencer',
  151: 'sequencer',
  152: 'sequencer',
  153: 'sequencer',
  154: 'sequencer',
  155: 'sequencer',
  156: 'sequencer',
  157: 'sequencer',
  158: 'sequencer',
  159: 'sequencer',
  160: 'sequencer',
  161: 'sequencer',
  162: 'sequencer',
  163: 'sequencer',
  164: 'sequencer',
  165: 'sequencer',
  166: 'sequencer',
  167: 'sequencer',
  168: 'sequencer',
  169: 'sequencer',
  170: 'sequencer',
  171: 'sequencer',
  172: 'sequencer',
  173: 'sequencer',
  174: 'sequencer',
  175: 'sequencer',
  176: 'sequencer',
  177: 'sequencer',
  178: 'sequencer',
  179: 'sequencer',
  180: 'sequencer',
  181: 'sequencer',
  182: 'sequencer',
  183: 'sequencer',
  184: 184,
  185: 185,
  186: 186,
  187: 187,
  188: 188,
  189: 189,
  190: 190,
  191: 191,
  192: 192,
  193: 193,
  194: 194,
  195: 195,
  196: 196,
  197: 197,
  198: 198,
  199: 199,
  200: 200,
  201: 201,
  202: 202,
  203: 203,
  204: 204,
  205: 205,
  206: 206,
  207: 207,
  208: 208,
  209: 209,
  210: 210,
  211: 211,
  212: 212,
  213: 213,
  214: 214,
  215: 215,
  216: 216,
  217: 217,
  218: 218,
  219: 219,
  220: 220,
  221: 221,
  222: 222,
  223: 223,
  224: 224,
  225: 225,
  226: 226,
  227: 227,
  228: 228,
  229: 229,
  230: 230,
  231: 231,
  232: 232,
  233: 233,
  234: 234,
  235: 235,
  236: 236,
  237: 237,
  238: 238,
  239: 239,
  240: 240,
  241: 241,
  242: 242,
  243: 243,
  244: 244,
  245: 245,
  246: 246,
  247: 247,
  248: 248,
  249: 249,
  250: 250,
  251: 251,
  252: 252,
  253: 253,
  254: 254,
  255: 255
};

function list()
{
  messnamed('---logger', 'clear');
  groups = [];
  for (i = 0; i < arguments.length; i++) {
    group = Math.floor(i / 8);
    position = i % 8;
    if (typeof(groups[group]) == 'undefined') {
      groups[group] = [];
    }
    groups[group][position] = arguments[i];
  }
  params = [];
  for (group_index = 0; group_index < groups.length; group_index++) {
    group = groups[group_index];
    msb = group[0];
    for (param_index = 1; param_index < 8; param_index++) {
      param_value = group[param_index];
      if (typeof(param_value) != 'undefined') {
        // Thanks to chysn for this unpacking algorithm
        // http://prophet5.org/viewtopic.php?t=577&sid=f32f9892564429fee15d2b1d9ae9ac2c
        if (msb & (1 << (param_index - 1))) {
          param_value |= 0x80;
        }
        params.push(param_value);
      }
    }
  }
  for (i = 0; i < params.length; i++) {
    var destination;
    var value;
    if (param_to_nprn_map[i] == 'sequencer') {
      destination = 'sequencer'
      value = [i, params[i]];
      outlet(1, [i, params[i]]);
    } else {
      destination = param_to_nprn_map[i];
      value = params[i];
      outlet(0, [destination, value]);
    }
    //messnamed(destination, value);
    //post(destination + ': ' + value.toString());
    //post();
  }
}
